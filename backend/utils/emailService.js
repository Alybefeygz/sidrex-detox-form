const nodemailer = require('nodemailer');
const logger = require('./logger');

class EmailService {
    constructor() {
        this.transporter = null;
        this.isConfigured = false;
        this.initializeTransporter();
    }

    initializeTransporter() {
        try {
            // Check if email configuration is provided
            if (!process.env.EMAIL_HOST || !process.env.EMAIL_USER || !process.env.EMAIL_PASS) {
                logger.warn('Email konfig√ºrasyonu bulunamadƒ±. Email servisi devre dƒ±≈üƒ±.');
                return;
            }

            this.transporter = nodemailer.createTransporter({
                host: process.env.EMAIL_HOST,
                port: parseInt(process.env.EMAIL_PORT) || 587,
                secure: false, // true for 465, false for other ports
                auth: {
                    user: process.env.EMAIL_USER,
                    pass: process.env.EMAIL_PASS
                },
                tls: {
                    rejectUnauthorized: false
                }
            });

            this.isConfigured = true;
            logger.info('Email servisi ba≈ülatƒ±ldƒ±');

        } catch (error) {
            logger.error('Email servis ba≈ülatma hatasƒ±:', error);
            this.isConfigured = false;
        }
    }

    async verifyConnection() {
        if (!this.isConfigured) {
            throw new Error('Email servisi konfig√ºre edilmemi≈ü');
        }

        try {
            await this.transporter.verify();
            logger.info('Email baƒülantƒ±sƒ± ba≈üarƒ±lƒ±');
            return true;
        } catch (error) {
            logger.error('Email baƒülantƒ± hatasƒ±:', error);
            throw error;
        }
    }

    async sendEmail(options) {
        if (!this.isConfigured) {
            logger.warn('Email g√∂nderilemiyor - servis konfig√ºre edilmemi≈ü');
            return false;
        }

        try {
            const mailOptions = {
                from: process.env.EMAIL_FROM || process.env.EMAIL_USER,
                to: options.to,
                subject: options.subject,
                html: options.html,
                text: options.text || this.htmlToText(options.html),
                attachments: options.attachments || []
            };

            const result = await this.transporter.sendMail(mailOptions);
            
            logger.info('Email g√∂nderildi', {
                to: options.to,
                subject: options.subject,
                messageId: result.messageId
            });

            return result;

        } catch (error) {
            logger.error('Email g√∂nderim hatasƒ±:', error);
            throw error;
        }
    }

    async sendApplicationNotification(applicationData) {
        if (!this.isConfigured) {
            return false;
        }

        try {
            const subject = 'Yeni Detoks Form Ba≈üvurusu';
            const html = this.generateApplicationNotificationHTML(applicationData);

            // Admin'e bildirim g√∂nder
            const adminEmail = process.env.ADMIN_EMAIL;
            if (adminEmail) {
                await this.sendEmail({
                    to: adminEmail,
                    subject: subject,
                    html: html
                });
            }

            // Ba≈üvuru sahibine onay maili g√∂nder (eƒüer email varsa)
            if (applicationData.email) {
                await this.sendApplicationConfirmation(applicationData);
            }

            return true;

        } catch (error) {
            logger.error('Ba≈üvuru bildirimi g√∂nderim hatasƒ±:', error);
            throw error;
        }
    }

    async sendApplicationConfirmation(applicationData) {
        if (!this.isConfigured || !applicationData.email) {
            return false;
        }

        try {
            const subject = 'Detoks Form Ba≈üvurunuz Alƒ±ndƒ±';
            const html = this.generateConfirmationHTML(applicationData);

            await this.sendEmail({
                to: applicationData.email,
                subject: subject,
                html: html
            });

            return true;

        } catch (error) {
            logger.error('Onay maili g√∂nderim hatasƒ±:', error);
            throw error;
        }
    }

    async sendStatusUpdateNotification(applicationData) {
        if (!this.isConfigured || !applicationData.email) {
            return false;
        }

        try {
            const statusMessages = {
                approved: 'Ba≈üvurunuz Onaylandƒ±',
                rejected: 'Ba≈üvuru Durumu G√ºncellendi',
                contacted: 'Ba≈üvurunuz ƒ∞nceleniyor'
            };

            const subject = statusMessages[applicationData.status] || 'Ba≈üvuru Durumu G√ºncellendi';
            const html = this.generateStatusUpdateHTML(applicationData);

            await this.sendEmail({
                to: applicationData.email,
                subject: subject,
                html: html
            });

            return true;

        } catch (error) {
            logger.error('Durum g√ºncelleme maili g√∂nderim hatasƒ±:', error);
            throw error;
        }
    }

    generateApplicationNotificationHTML(applicationData) {
        return `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8">
            <style>
                body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
                .container { max-width: 600px; margin: 0 auto; padding: 20px; }
                .header { background: #4CAF50; color: white; padding: 20px; text-align: center; }
                .content { padding: 20px; background: #f9f9f9; }
                .field { margin: 10px 0; padding: 10px; background: white; border-radius: 5px; }
                .label { font-weight: bold; color: #555; }
                .value { margin-top: 5px; }
                .footer { text-align: center; padding: 20px; color: #666; font-size: 0.9em; }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <h1>üÜï Yeni Detoks Form Ba≈üvurusu</h1>
                </div>
                <div class="content">
                    <div class="field">
                        <div class="label">Ba≈üvuru ID:</div>
                        <div class="value">${applicationData.id}</div>
                    </div>
                    <div class="field">
                        <div class="label">Ad Soyad:</div>
                        <div class="value">${applicationData.fullName}</div>
                    </div>
                    <div class="field">
                        <div class="label">Ya≈ü:</div>
                        <div class="value">${applicationData.age}</div>
                    </div>
                    <div class="field">
                        <div class="label">Boy/Kilo:</div>
                        <div class="value">${applicationData.height} cm / ${applicationData.weight} kg</div>
                    </div>
                    <div class="field">
                        <div class="label">Meslek:</div>
                        <div class="value">${applicationData.occupation}</div>
                    </div>
                    ${applicationData.email ? `
                    <div class="field">
                        <div class="label">Email:</div>
                        <div class="value">${applicationData.email}</div>
                    </div>
                    ` : ''}
                    ${applicationData.phone ? `
                    <div class="field">
                        <div class="label">Telefon:</div>
                        <div class="value">${applicationData.phone}</div>
                    </div>
                    ` : ''}
                    <div class="field">
                        <div class="label">Ba≈üvuru Tarihi:</div>
                        <div class="value">${applicationData.createdAt}</div>
                    </div>
                </div>
                <div class="footer">
                    <p>Bu otomatik bir bildirimdir. Admin panelinden ba≈üvuruyu inceleyebilirsiniz.</p>
                </div>
            </div>
        </body>
        </html>
        `;
    }

    generateConfirmationHTML(applicationData) {
        return `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8">
            <style>
                body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
                .container { max-width: 600px; margin: 0 auto; padding: 20px; }
                .header { background: #2196F3; color: white; padding: 20px; text-align: center; }
                .content { padding: 20px; background: #f9f9f9; }
                .info-box { background: white; padding: 15px; border-radius: 5px; margin: 15px 0; }
                .footer { text-align: center; padding: 20px; color: #666; font-size: 0.9em; }
                .success { color: #4CAF50; font-weight: bold; }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <h1>‚úÖ Ba≈üvurunuz Alƒ±ndƒ±</h1>
                </div>
                <div class="content">
                    <p>Merhaba <strong>${applicationData.fullName}</strong>,</p>
                    
                    <div class="info-box">
                        <p class="success">Detoks form ba≈üvurunuz ba≈üarƒ±yla alƒ±nmƒ±≈ütƒ±r!</p>
                        <p><strong>Ba≈üvuru ID:</strong> ${applicationData.id}</p>
                        <p><strong>Ba≈üvuru Tarihi:</strong> ${applicationData.createdAt}</p>
                    </div>

                    <div class="info-box">
                        <h3>Sonraki Adƒ±mlar:</h3>
                        <ul>
                            <li>Ba≈üvurunuz uzman ekibimiz tarafƒ±ndan incelenecektir</li>
                            <li>24-48 saat i√ßinde size geri d√∂n√º≈ü yapƒ±lacaktƒ±r</li>
                            <li>Gerekli g√∂r√ºld√ºƒü√º takdirde ek bilgi veya belge talep edilebilir</li>
                        </ul>
                    </div>

                    <div class="info-box">
                        <h3>ƒ∞leti≈üim:</h3>
                        <p>Sorularƒ±nƒ±z i√ßin bizimle ileti≈üime ge√ßebilirsiniz.</p>
                        <p>Bu email adresini referans g√∂stererek ba≈üvuru ID'nizle birlikte yazabilirsiniz.</p>
                    </div>
                </div>
                <div class="footer">
                    <p>Sidrex Detoks Programƒ±</p>
                    <p>Bu otomatik bir onay emailidir.</p>
                </div>
            </div>
        </body>
        </html>
        `;
    }

    generateStatusUpdateHTML(applicationData) {
        const statusTexts = {
            approved: {
                title: 'üéâ Ba≈üvurunuz Onaylandƒ±!',
                message: 'Tebrikler! Detoks programƒ±na katƒ±lƒ±m ba≈üvurunuz onaylanmƒ±≈ütƒ±r.',
                color: '#4CAF50'
            },
            rejected: {
                title: 'üìã Ba≈üvuru Durumu',
                message: 'Ba≈üvurunuz deƒüerlendirilmi≈ü ve bu sefer uygun g√∂r√ºlmemi≈ütir.',
                color: '#FF9800'
            },
            contacted: {
                title: 'üìû Ba≈üvurunuz ƒ∞nceleniyor',
                message: 'Ba≈üvurunuz inceleme a≈üamasƒ±ndadƒ±r. Kƒ±sa s√ºre i√ßinde sizinle ileti≈üime ge√ßeceƒüiz.',
                color: '#2196F3'
            }
        };

        const status = statusTexts[applicationData.status] || statusTexts.contacted;

        return `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8">
            <style>
                body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
                .container { max-width: 600px; margin: 0 auto; padding: 20px; }
                .header { background: ${status.color}; color: white; padding: 20px; text-align: center; }
                .content { padding: 20px; background: #f9f9f9; }
                .info-box { background: white; padding: 15px; border-radius: 5px; margin: 15px 0; }
                .footer { text-align: center; padding: 20px; color: #666; font-size: 0.9em; }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <h1>${status.title}</h1>
                </div>
                <div class="content">
                    <p>Merhaba <strong>${applicationData.fullName}</strong>,</p>
                    
                    <div class="info-box">
                        <p>${status.message}</p>
                        <p><strong>Ba≈üvuru ID:</strong> ${applicationData.id}</p>
                        <p><strong>G√ºncelleme Tarihi:</strong> ${applicationData.updatedAt}</p>
                    </div>

                    ${applicationData.adminNotes ? `
                    <div class="info-box">
                        <h3>Notlar:</h3>
                        <p>${applicationData.adminNotes}</p>
                    </div>
                    ` : ''}

                    <div class="info-box">
                        <p>Sorularƒ±nƒ±z i√ßin bizimle ileti≈üime ge√ßebilirsiniz.</p>
                    </div>
                </div>
                <div class="footer">
                    <p>Sidrex Detoks Programƒ±</p>
                    <p>Bu otomatik bir bildirim emailidir.</p>
                </div>
            </div>
        </body>
        </html>
        `;
    }

    htmlToText(html) {
        if (!html) return '';
        return html
            .replace(/<[^>]*>/g, '')
            .replace(/&nbsp;/g, ' ')
            .replace(/&amp;/g, '&')
            .replace(/&lt;/g, '<')
            .replace(/&gt;/g, '>')
            .trim();
    }
}

// Create and export a singleton instance
const emailService = new EmailService();

module.exports = emailService;